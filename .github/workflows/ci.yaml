name: UEFI CI/CD

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Install Git (Pre-requisite)
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel python3 python nasm \
            gcc make gptfdisk mtools qemu-full edk2-ovmf

      - name: Build S4 Image (Generator)
        run: |
          chmod +x scripts/gen_s4img_default.sh
          ./scripts/gen_s4img_default.sh

      - name: Compile EDK2 BaseTools
        run: |
          make -C uefi/edk2/BaseTools

      - name: Build UEFI Application
        run: |
          chmod +x scripts/build_uefi.sh
          ./scripts/build_uefi.sh

      - name: Test Simulation (Headless QEMU)
        run: |
          echo "Starting QEMU verification..."

          chmod +x scripts/run_qemu.sh
          
          timeout 15s ./scripts/run_qemu.sh > simulation.log 2>&1 || true

          echo "=== QEMU Output Log ==="
          cat simulation.log
          
          if grep -q "Hi" simulation.log; then
            echo "SUCCESS: Activator started and jumped to trampoline successfully."
          else
            echo "FAILURE: Activator did not jump to trampoline."
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: uefi-build-artifacts
          path: |
            bin/Activator.efi
            bin/disk.img
            bin/s4_image.bin